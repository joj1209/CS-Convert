# 2026-02-10 변경사항 상세 (comMapper)

본 문서는 2026-02-10 추가 요구사항 반영으로 수정된 **comMapper** 화면의 동작 변경을 상세히 정리합니다.

## 배경 / 문제

1) `vs_job_d`가 `'999912'`로 변환되는 이슈
- DM 변환 규칙에 의해 `vs_job_d`(백틱 유무 모두)를 `'999912'`로 치환하도록 매핑이 생성됩니다.
- 기존 UI에서는 “@변수만 변환” 체크박스가 **기본 해제** 상태였기 때문에,
  사용자가 별도 조작을 하지 않아도 `vs_job_d` 같은 `@`가 아닌 토큰까지 치환되는 상황이 발생할 수 있었습니다.

2) 화면에서 사용자가 매핑을 입력/수정했는데, 변환 버튼을 다시 누르면 기본 매핑이 다시 렌더되어 사용 입력이 우선 적용되지 않는 문제
- 변환 실행 시 기본 매핑을 다시 그리면서, 사용자가 입력한 값의 “우선순위”가 불명확했습니다.

---

## 변경된 파일

- `comMapper.html`
- `js/comMapper.js`

---

## 1) comMapper.html 변경: “@변수만 변환” 기본 ON

### 변경 목적
- 요구사항: **`vs_job_d`가 `'999912'`로 변환되더라도, 기본적으로는 `@변수`만 변환**되도록 해야 함.
- 즉, 사용자가 “@변수만 변환”을 켠 상태에서 변환 버튼을 누르면 **`@`로 시작하는 매핑만 적용**되도록 유도.

### 변경 내용
- 체크박스 `id="onlyAtVars"`에 `checked` 속성을 추가하여 **초기 상태를 체크됨(ON)** 으로 변경.

### 변경 후 동작
- 기본 상태(체크됨):
  - `@program_id`, `@standard_date`, `@table_name` 같은 `@변수`만 치환
  - `vs_job_d`, `` `vs_job_d` ``, `` `edw_전월` `` 같은 `@`가 아닌 토큰은 치환되지 않음
- 사용자가 체크 해제(OFF)하면:
  - 기존처럼 `vs_job_d`, `` `vs_job_d` ``, `` `edw_...` `` 등도 함께 치환 가능

---

## 2) comMapper.js 변경: UI 입력값 우선(사용자 매핑 우선순위 적용)

### 변경 목적
- 요구사항: “화면에서 한번 변수변환 텍스트 박스에 입력했으면 입력한 값을 우선순위로 적용”
- 변환 버튼을 여러 번 누르거나 DW/DM 모드를 다시 선택해도,
  **사용자가 입력/수정한 매핑값이 기본 매핑보다 우선**되어야 함.

### 핵심 아이디어
- 변환 시점에 다음을 수행:
  1) 현재 UI의 매핑 입력값을 먼저 읽음 (`readMappingsFromUi()`)
  2) SQL을 기반으로 기본 매핑을 생성 (`buildDwMappings` / `buildDmMappings`)
  3) 기본 매핑 + 사용자 매핑을 병합하되, 동일 `from` 키에 대해서는 **사용자 `to`가 비어있지 않으면 사용자 값을 우선**
  4) 병합된 결과를 다시 UI에 렌더 (`renderMappings`)하여 사용자가 입력한 값이 유지되도록 함
  5) 병합된 매핑을 실제 치환에 사용 (`applyMappings`)

### 추가된 함수: `mergeMappings(defaultMappings, userMappings)`

병합 규칙은 다음과 같습니다.

1) **기본 매핑의 순서를 유지**합니다.
- 기본 매핑은 규칙 기반으로 자동 생성되는 값들이라, UI에서 보기 좋게 핵심 항목이 상단에 오도록 되어 있습니다.

2) 동일한 `from`이 존재할 때 우선순위
- `userMappings`에 동일한 `from`이 있고,
- 그 `to`가 공백이 아닌 값이면 → **사용자 `to`로 덮어씀(우선 적용)**
- 사용자 `to`가 비어있으면 → 기본 매핑의 `to`를 유지

3) 사용자가 새로 추가한 매핑
- 기본 매핑에 없는 `from`을 사용자가 UI에 추가한 경우,
  그 매핑은 병합 결과에 **추가로 append** 됩니다.

4) 중복 정리
- 병합된 매핑은 `normalizeAndDedupeMappings`를 통해 중복이 정리됩니다.

### `convert(mode)` 흐름 변경

- 변경 전(개념):
  - 기본 매핑 생성 → UI 렌더 → UI 다시 읽기 → (옵션 필터) → 치환

- 변경 후(개념):
  - UI 먼저 읽기(사용자 입력 확보) → 기본 매핑 생성 → **병합(사용자 우선)** → UI 렌더 → (옵션 필터) → 치환

### 주의/의도된 동작

- 사용자가 `to`를 “완전히 빈 값”으로 두면 기본값이 유지됩니다.
  - 예: 사용자가 실수로 지워버린 경우 기본값이 다시 보이도록 하는 안전장치
- 정말로 빈 문자열로 치환을 의도한다면 `''` 같은 값을 입력하면 됩니다.

---

## 3) 요구사항 관점에서의 결과

### “vs_job_d는 @변수만 변환해야 한다”
- 기본 상태에서 “@변수만 변환”이 ON이므로,
  `vs_job_d` 매핑이 생성되어 있어도 실제 적용 단계에서 필터링되어 치환되지 않습니다.
- 필요 시 사용자가 체크를 해제해서 `vs_job_d`까지 치환하는 기존 동작도 유지됩니다.

### “한번 입력한 값이 우선 적용”
- 사용자가 매핑 텍스트박스의 값을 편집하면,
  이후 변환에서도 **사용자 값이 기본 매핑보다 우선 적용**되어 결과 SQL에 반영됩니다.

---

## 4) 간단 테스트 시나리오 (수동 확인)

1) comMapper 화면에서 SQL 입력
- `vs_job_d` 또는 `` `vs_job_d` `` 포함된 SQL을 입력

2) DM 변환 클릭
- 기본 상태에서 “@변수만 변환”이 체크되어 있어야 함
- 결과에서 `vs_job_d`가 `'999912'`로 바뀌지 않아야 함

3) “@변수만 변환” 체크 해제 후 DM 변환 클릭
- 결과에서 `vs_job_d`가 `'999912'`로 바뀌어야 함

4) 매핑 입력값 우선 확인
- 매핑 UI에서 `@standard_date`의 `to`를 예: `'20250101'`로 변경
- DM 변환을 다시 클릭해도 해당 값이 유지되고 결과 SQL에도 반영되어야 함

---

## 참고

- 이 변경은 comMapper 화면에만 적용되었습니다.
- 기존 DW/DM 기본 매핑 생성 규칙 자체는 변경하지 않았고,
  **(1) 기본 옵션 상태**와 **(2) 사용자 입력 우선순위**만 개선했습니다.
